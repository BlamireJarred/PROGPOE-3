@model List<PROG6212_POE.Models.Claim>

@{
    ViewData["Title"] = "Lecturer Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Submit a Claim</h2>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}

<form asp-action="SubmitClaim" method="post" enctype="multipart/form-data" class="mb-4" id="claimForm">
    <div class="mb-3">
        <label class="form-label">Lecturer Name</label>
        <input name="LecturerName" class="form-control" required id="lecturerName" />
        <div class="invalid-feedback">Please provide your name.</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Contract Name</label>
        <input name="ContractName" class="form-control" required id="contractName" />
        <div class="invalid-feedback">Please provide the contract name.</div>
    </div>

    <div class="row mb-3">
        <div class="col">
            <label class="form-label">Hours Worked (1-200)</label>
            <input name="HoursWorked" type="number" class="form-control" min="1" max="200" required
                   id="hoursWorked" oninput="calculateTotal()" />
            <div class="invalid-feedback">Hours worked must be between 1 and 200.</div>
        </div>
        <div class="col">
            <label class="form-label">Hourly Rate (R20.00 - R500.00)</label>
            <input name="HourlyRate" type="number" step="0.01" class="form-control" min="20" max="500" required
                   id="hourlyRate" oninput="calculateTotal()" />
            <div class="invalid-feedback">Hourly rate must be between R20.00 and R500.00.</div>
        </div>
    </div>

    <!-- Auto-calculated Total Display -->
    <div class="row mb-3">
        <div class="col">
            <div class="card bg-light">
                <div class="card-body">
                    <h6 class="card-title">Payment Summary</h6>
                    <div class="row">
                        <div class="col">
                            <strong>Hours:</strong> <span id="displayHours">0</span>
                        </div>
                        <div class="col">
                            <strong>Rate:</strong> <span id="displayRate">R0.00</span>
                        </div>
                        <div class="col">
                            <strong>Total Amount:</strong> <span id="displayTotal" class="text-success fw-bold">R0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">Supporting Document (PDF, DOCX, XLSX, JPG, PNG - Max 5MB)</label>
        <input type="file" name="SupportingDocument" class="form-control" accept=".pdf,.docx,.xlsx,.jpg,.png"
               id="supportingDocument" onchange="validateFile(this)" />
        <div class="form-text">Allowed file types: PDF, DOCX, XLSX, JPG, PNG. Maximum file size: 5MB</div>
        <div class="invalid-feedback" id="fileError"></div>
    </div>

    <button type="submit" class="btn btn-primary" id="submitButton">Submit Claim</button>
</form>

<hr />

<h2>My Claims</h2>

@if (!Model.Any())
{
    <div class="alert alert-info">No claims submitted yet.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Contract</th>
                    <th>Hours</th>
                    <th>Rate</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Document</th>
                    <th>Submitted</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var claim in Model)
                {
                    <tr>
                        <td>@claim.Id</td>
                        <td>@claim.ContractName</td>
                        <td>@claim.HoursWorked</td>
                        <td>@claim.HourlyRate.ToString("C")</td>
                        <td><strong>@claim.TotalAmount.ToString("C")</strong></td>
                        <td>
                            <span class="badge @GetStatusBadgeClass(claim.ApprovalStatus)">@claim.ApprovalStatus</span>
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(claim.SupportingDocumentPath))
                            {
                                <a href="@claim.SupportingDocumentPath" download class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-download me-1"></i>Download
                                </a>
                            }
                            else
                            {
                                <span class="text-muted">No document</span>
                            }
                        </td>
                        <td>@claim.SubmittedDate.ToString("MMM dd, yyyy")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@section Scripts {
    <script>
        // Auto-calculation function
        function calculateTotal() {
            const hours = parseFloat(document.getElementById('hoursWorked').value) || 0;
            const rate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const total = hours * rate;

            // Update display
            document.getElementById('displayHours').textContent = hours;
            document.getElementById('displayRate').textContent = 'R' + rate.toFixed(2);
            document.getElementById('displayTotal').textContent = 'R' + total.toFixed(2);

            // Validate and update UI
            validateFields();
        }

        // Real-time field validation
        function validateFields() {
            const hours = parseFloat(document.getElementById('hoursWorked').value) || 0;
            const rate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const submitButton = document.getElementById('submitButton');

            let isValid = true;

            // Validate hours
            if (hours < 1 || hours > 200 || isNaN(hours)) {
                document.getElementById('hoursWorked').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('hoursWorked').classList.remove('is-invalid');
            }

            // Validate rate
            if (rate < 15 || rate > 500 || isNaN(rate)) {
                document.getElementById('hourlyRate').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('hourlyRate').classList.remove('is-invalid');
            }

            // Validate names
            if (!lecturerName) {
                document.getElementById('lecturerName').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('lecturerName').classList.remove('is-invalid');
            }

            if (!contractName) {
                document.getElementById('contractName').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('contractName').classList.remove('is-invalid');
            }

            // Enable/disable submit button
            submitButton.disabled = !isValid;
        }

        // File validation
        function validateFile(input) {
            const fileError = document.getElementById('fileError');
            const file = input.files[0];

            if (file) {
                const fileSize = file.size / 1024 / 1024; // MB
                const fileName = file.name;
                const fileExtension = fileName.split('.').pop().toLowerCase();
                const allowedExtensions = ['pdf', 'docx', 'xlsx', 'jpg', 'png'];

                if (!allowedExtensions.includes(fileExtension)) {
                    fileError.textContent = 'Invalid file type. Please select PDF, DOCX, XLSX, JPG, or PNG files.';
                    input.classList.add('is-invalid');
                    return false;
                }

                if (fileSize > 5) {
                    fileError.textContent = 'File size exceeds 5MB limit. Please choose a smaller file.';
                    input.classList.add('is-invalid');
                    return false;
                }

                // Valid file
                fileError.textContent = '';
                input.classList.remove('is-invalid');
                return true;
            }

            fileError.textContent = '';
            input.classList.remove('is-invalid');
            return true;
        }

        // Form submission validation
        document.getElementById('claimForm').addEventListener('submit', function(e) {
            const hours = parseFloat(document.getElementById('hoursWorked').value);
            const rate = parseFloat(document.getElementById('hourlyRate').value);
            const fileInput = document.getElementById('supportingDocument');

            if (hours < 1 || hours > 200) {
                e.preventDefault();
                alert('Hours worked must be between 1 and 200.');
                return false;
            }

            if (rate < 15 || rate > 500) {
                e.preventDefault();
                alert('Hourly rate must be between R20.00 and R500.00.');
                return false;
            }

            if (fileInput.files.length > 0) {
                if (!validateFile(fileInput)) {
                    e.preventDefault();
                    return false;
                }
            }

            return true;
        });

        // Real-time validation on input
        document.getElementById('lecturerName').addEventListener('input', validateFields);
        document.getElementById('contractName').addEventListener('input', validateFields);
        document.getElementById('hoursWorked').addEventListener('input', validateFields);
        document.getElementById('hourlyRate').addEventListener('input', validateFields);

        // Initialize validation on page load
        document.addEventListener('DOMContentLoaded', function() {
            validateFields();
            calculateTotal();
        });
    </script>
}

@functions {
    public string GetStatusBadgeClass(string status)
    {
        return status?.ToLower() switch
        {
            "approved" => "bg-success",
            "rejected" => "bg-danger",
            "pending both" => "bg-warning",
            "awaiting manager" => "bg-info",
            "awaiting coordinator" => "bg-primary",
            _ => "bg-secondary"
        };
    }
}